## Manage what image of each examples to run
##
## Default:
##   make deploy-xdp
##     quay.io/bpfman-bytecode/go-xdp-counter:latest
##     quay.io/bpfman-userspace/go-xdp-counter:latest
##
## Example: Override the upstream tag
##   make deploy-tc TAG=v0.1.0
##     quay.io/bpfman-bytecode/go-tc-counter:v0.1.0
##     quay.io/bpfman-userspace/go-uc-counter:v0.1.0
##
## Example: Run from private image
##   make deploy-tracepoint IMAGE_TP_US=docker.io/user1/tracepoint-userspace:test \
##                          IMAGE_TP_BC=docker.io/user1/tracepoint-bytecode:test
##     docker.io/user1/tracepoint-bytecode:test
##     docker.io/user1/tracepoint-userspace:test
##
## Example: Override the upstream tag on all images
##   make deploy TAG=v0.1.0
##     quay.io/bpfman-bytecode/go-tc-counter:v0.1.0
##     quay.io/bpfman-userspace/go-uc-counter:v0.1.0
##     quay.io/bpfman-bytecode/go-tracepoint-counter:v0.1.0
##     quay.io/bpfman-userspace/go-tracepoint-counter:v0.1.0
##     quay.io/bpfman-bytecode/go-xdp-counter:v0.1.0
##     quay.io/bpfman-userspace/go-xdp-counter:v0.1.0
##     quay.io/bpfman-userspace/go-app-counter:v0.1.0
##     :
##

# VERSION defines the project version for the bundle.
# Update this value when you upgrade the version of your project.
# To re-generate a bundle for another specific version without changing the standard setup, you can:
# - use environment variables to overwrite this value (e.g export VERSION=0.5.4)
VERSION ?= 0.5.4

.DEFAULT_GOAL := help

# Get the currently used golang install path (in GOPATH/bin, unless GOBIN is set)
ifeq (,$(shell go env GOBIN))
GOBIN=$(shell go env GOPATH)/bin
else
GOBIN=$(shell go env GOBIN)
endif

# Setting SHELL to bash allows bash commands to be executed by recipes.
# Options are set to exit when a recipe line exits non-zero or a piped command fails.
SHELL = /usr/bin/env bash -o pipefail
.SHELLFLAGS = -ec

.PHONY: all
all: build

##@ General

# The help target prints out all targets with their descriptions organized
# beneath their categories. The categories are represented by '##@' and the
# target descriptions by '##'. The awk commands is responsible for reading the
# entire set of makefiles included in this invocation, looking for lines of the
# file as xyz: ## something, and then pretty-format the target and help. Then,
# if there's a line with ##@ something, that gets pretty-printed as a category.
# More info on the usage of ANSI control characters for terminal formatting:
# https://en.wikipedia.org/wiki/ANSI_escape_code#SGR_parameters
# More info on the awk command:
# http://linuxcommand.org/lc3_adv_awk.php

.PHONY: help
help: ## Display this help.
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n  make \033[36mdeploy\033[0m TAG=v0.2.0\n  make \033[36mdeploy-xdp\033[0m IMAGE_XDP_US=quay.io/user1/go-xdp-counter-userspace:test\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Local Dependencies
ignore-not-found ?= false

## Location to install dependencies to
LOCALBIN ?= $(shell pwd)/bin
$(LOCALBIN):
	mkdir -p $(LOCALBIN)

## Tool Binaries
KUSTOMIZE ?= $(LOCALBIN)/kustomize

## Tool Versions
KUSTOMIZE_VERSION ?= v3.8.7

KUSTOMIZE_INSTALL_SCRIPT ?= "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"
.PHONY: kustomize
kustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.
$(KUSTOMIZE): $(LOCALBIN)
	test -s $(LOCALBIN)/kustomize || { curl -Ss $(KUSTOMIZE_INSTALL_SCRIPT) | bash -s -- $(subst v,,$(KUSTOMIZE_VERSION)) $(LOCALBIN); }

GOARCH ?= $(shell go env GOHOSTARCH)
PLATFORM ?= $(shell go env GOHOSTOS)/$(shell go env GOHOSTARCH)

##@ Development

.PHONY: fmt
fmt: ## Run go fmt against code.
	go fmt ./...

.PHONY: verify
verify: ## Verify all the autogenerated code
	./hack/verify-codegen.sh

##@ Build

.PHONY: build
build: fmt ## Build all the userspace example code.
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-tc-counter/go-tc-counter go-tc-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-tcx-counter/go-tcx-counter go-tcx-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-tracepoint-counter/go-tracepoint-counter go-tracepoint-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-xdp-counter/go-xdp-counter go-xdp-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-kprobe-counter/go-kprobe-counter go-kprobe-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-uprobe-counter/go-uprobe-counter go-uprobe-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-uretprobe-counter/go-uretprobe-counter go-uretprobe-counter/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-target/go-target go-target/main.go
	CGO_ENABLED=0 GOOS=linux GOARCH=$(GOARCH) go build -o go-app-counter/go-app-counter \
	go-app-counter/main.go go-app-counter/kprobe_main.go go-app-counter/tracepoint_main.go \
	go-app-counter/uprobe_main.go go-app-counter/tc_main.go go-app-counter/tcx_main.go go-app-counter/xdp_main.go

.PHONY: generate
generate: ## Run `go generate` to build the bytecode for each of the examples.
	go generate ./...

.PHONY: build-release-yamls
build-release-yamls: kustomize ## Generate yamls examples for a specific release version.
	VERSION=$(VERSION) ./build-release-yamls.sh


.PHONY: build-bc-images
build-bc-images: generate ## Build all example bytecode images
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_TC_BC} -b ./go-tc-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_TCX_BC} -b ./go-tcx-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_TP_BC} -b ./go-tracepoint-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_XDP_BC} -b ./go-xdp-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_KP_BC} -b ./go-kprobe-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_UP_BC} -b ./go-uprobe-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_URP_BC} -b ./go-uretprobe-counter/bpf_x86_bpfel.o
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_APP_BC} -b ./go-app-counter/bpf_x86_bpfel.o

.PHONY: build-bc-tc
build-bc-tc: generate ## Build TC example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_TC_BC} -b ./go-tc-counter/bpf_x86_bpfel.o

.PHONY: build-bc-tp
build-bc-tp: generate ## Build Tracepoint example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_TP_BC} -b ./go-tracepoint-counter/bpf_x86_bpfel.o

.PHONY: build-bc-xdp
build-bc-xdp: generate ## Build XDP example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_XDP_BC} -b ./go-xdp-counter/bpf_x86_bpfel.o

.PHONY: build-bc-kprobe
build-bc-kprobe: generate ## Build kprobe example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_KP_BC} -b ./go-kprobe-counter/bpf_x86_bpfel.o

.PHONY: build-bc-uprobe
build-bc-uprobe: generate ## Build uprobe example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_UP_BC} -b ./go-uprobe-counter/bpf_x86_bpfel.o

.PHONY: build-bc-uretprobe
build-bc-uretprobe: generate ## Build uretprobe example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_URP_BC} -b ./go-uretprobe-counter/bpf_x86_bpfel.o

.PHONY: build-bc-app
build-bc-app: generate ## Build application example bytecode image
	bpfman image build -f ../Containerfile.bytecode -t ${IMAGE_APP_BC} -b ./go-app-counter/bpf_x86_bpfel.o


.PHONY: build-us-images
build-us-images: build ## Build all example userspace images
	docker buildx build -t ${IMAGE_TC_US}  --platform ${PLATFORM} --load -f ./go-tc-counter/container-deployment/Containerfile.go-tc-counter ../
	docker buildx build -t ${IMAGE_TCX_US} --platform ${PLATFORM} --load -f ./go-tcx-counter/container-deployment/Containerfile.go-tcx-counter ../
	docker buildx build -t ${IMAGE_TP_US}  --platform ${PLATFORM} --load -f ./go-tracepoint-counter/container-deployment/Containerfile.go-tracepoint-counter ../
	docker buildx build -t ${IMAGE_XDP_US} --platform ${PLATFORM} --load -f ./go-xdp-counter/container-deployment/Containerfile.go-xdp-counter ../
	docker buildx build -t ${IMAGE_KP_US}  --platform ${PLATFORM} --load -f ./go-kprobe-counter/container-deployment/Containerfile.go-kprobe-counter ../
	docker buildx build -t ${IMAGE_UP_US}  --platform ${PLATFORM} --load -f ./go-uprobe-counter/container-deployment/Containerfile.go-uprobe-counter ../
	docker buildx build -t ${IMAGE_URP_US} --platform ${PLATFORM} --load -f ./go-uretprobe-counter/container-deployment/Containerfile.go-uretprobe-counter ../
	docker buildx build -t ${IMAGE_GT_US}  --platform ${PLATFORM} --load -f ./go-target/container-deployment/Containerfile.go-target ../
	docker buildx build -t ${IMAGE_APP_US} --platform ${PLATFORM} --load -f ./go-app-counter/container-deployment/Containerfile.go-app-counter ../

.PHONY: build-us-tc
build-us-tc: build ## Build TC example userspace image
	docker buildx build -t ${IMAGE_TC_US} --platform ${PLATFORM} --load -f ./go-tc-counter/container-deployment/Containerfile.go-tc-counter ../

.PHONY: build-us-tp
build-us-tp: build ## Build Tracepoint example userspace image
	docker buildx build -t ${IMAGE_TP_US} --platform ${PLATFORM} --load -f ./go-tracepoint-counter/container-deployment/Containerfile.go-tracepoint-counter ../

.PHONY: build-us-xdp
build-us-xdp: build ## Build XDP example userspace image
	docker buildx build -t ${IMAGE_XDP_US} --platform ${PLATFORM} --load -f ./go-xdp-counter/container-deployment/Containerfile.go-xdp-counter ../

.PHONY: build-us-kprobe
build-us-kprobe: build ## Build kprobe example userspace image
	docker buildx build -t ${IMAGE_KP_US} --platform ${PLATFORM} --load -f ./go-kprobe-counter/container-deployment/Containerfile.go-kprobe-counter ../

.PHONY: build-us-uprobe
build-us-uprobe: build ## Build uprobe example userspace image
	docker buildx build -t ${IMAGE_UP_US} --platform ${PLATFORM} --load -f ./go-uprobe-counter/container-deployment/Containerfile.go-uprobe-counter ../

.PHONY: build-us-uretprobe
build-us-uretprobe: build ## Build uretprobe example userspace image
	docker buildx build -t ${IMAGE_URP_US} --platform ${PLATFORM} --load -f ./go-uretprobe-counter/container-deployment/Containerfile.go-uretprobe-counter ../

.PHONY: build-us-target
build-us-target: build ## Build target example userspace image
	docker buildx build -t ${IMAGE_GT_US} --platform ${PLATFORM} --load -f ./go-target/container-deployment/Containerfile.go-target ../

.PHONY: build-us-app
build-us-app: build ## Build application example userspace image
	docker buildx build -t ${IMAGE_APP_US} --platform ${PLATFORM} --load  -f ./go-app-counter/container-deployment/Containerfile.go-app-counter ../


.PHONY: push-us-images
push-us-images: ## Push all example userspace images
	docker push ${IMAGE_TC_US}
	docker push ${IMAGE_TCX_US}
	docker push ${IMAGE_TP_US}
	docker push ${IMAGE_XDP_US}
	docker push ${IMAGE_KP_US}
	docker push ${IMAGE_UP_US}
	docker push ${IMAGE_URP_US}
	docker push ${IMAGE_APP_US}
	docker push ${IMAGE_GT_US}

.PHONY: load-us-images-kind
load-us-images-kind: build-us-images ## Build and load all example userspace images into kind
	kind load docker-image ${IMAGE_TC_US} ${IMAGE_TCX_US} ${IMAGE_TP_US} ${IMAGE_XDP_US} ${IMAGE_KP_US} ${IMAGE_UP_US} ${IMAGE_GT_US} ${IMAGE_APP_US} --name ${KIND_CLUSTER_NAME}

##@ Build and Deployment Variables (not commands)
TAG: ## ONLY deploy commands. Used to set all images to a fixed tag. TAG takes precedence over TAG_BC or TAG_US. Example: make deploy TAG=v0.2.0
TAG_BC: ## Used to set all bytecode images to a given tag. Example: make deploy TAG_BC=test-bc
TAG_US: ## Used to set all userspace images to a given tag. Example: make build-us-images TAG_US=test; make deploy TAG_US=test-us
USER_BC: ## Used to set all bytecode images to a given respository account. Example: make deploy USER_BC=$QUAY_USER
USER_US: ## Used to set all userspace images to a given respository account. Example: make build-us-images USER_US=$QUAY_USER; make deploy USER_US=$QUAY_USER
IMAGE_TC_BC: ## TC Bytecode image. Example: make deploy-tc IMAGE_TC_BC=quay.io/user1/go-tc-counter-bytecode:test
IMAGE_TC_US: ## TC Userspace image. Example: make deploy-tc IMAGE_TC_US=quay.io/user1/go-tc-counter-userspace:test
IMAGE_TCX_BC: ## TCX Bytecode image. Example: make deploy-tcx IMAGE_TCX_BC=quay.io/user1/go-tcx-counter-bytecode:test
IMAGE_TCX_US: ## TCX Userspace image. Example: make deploy-tcx IMAGE_TCX_US=quay.io/user1/go-tcx-counter-userspace:test
IMAGE_TP_BC: ## Tracepoint Bytecode image. Example: make deploy-tracepoint IMAGE_TP_BC=quay.io/user1/go-tracepoint-counter-bytecode:test
IMAGE_TP_US: ## Tracepoint Userspace image. Example: make deploy-tracepoint IMAGE_TP_US=quay.io/user1/go-tracepoint-counter-userspace:test
IMAGE_XDP_BC: ## XDP Bytecode image. Example: make deploy-xdp IMAGE_XDP_BC=quay.io/user1/go-xdp-counter-bytecode:test
IMAGE_XDP_US: ## XDP Userspace image. Example: make deploy-xdp IMAGE_XDP_US=quay.io/user1/go-xdp-counter-userspace:test
IMAGE_KP_BC: ## Kprobe Bytecode image. Example: make deploy-kprobe IMAGE_KP_BC=quay.io/user1/go-kprobe-counter-bytecode:test
IMAGE_KP_US: ## Kprobe Userspace image. Example: make deploy-kprobe IMAGE_KP_US=quay.io/user1/go-kprobe-counter-userspace:test
IMAGE_UP_BC: ## Uprobe Bytecode image. Example: make deploy-uprobe IMAGE_UP_BC=quay.io/user1/go-uprobe-counter-bytecode:test
IMAGE_UP_US: ## Uprobe Userspace image. Example: make deploy-uprobe IMAGE_UP_US=quay.io/user1/go-uprobe-counter-userspace:test
IMAGE_URP_BC: ## URetprobe Userspace image. Example: make deploy-uretprobe IMAGE_URP_BC=quay.io/user1/go-uretprobe-counter-bytecode:test
IMAGE_URP_US: ## URetprobe Userspace image. Example: make deploy-uretprobe IMAGE_URP_US=quay.io/user1/go-uretprobe-counter-userspace:test
IMAGE_APP_BC: ## Application Userspace image. Example: make deploy-app IMAGE_URP_BC=quay.io/user1/go-app-counter-bytecode:test
IMAGE_APP_US: ## Application Userspace image. Example: make deploy-app IMAGE_URP_US=quay.io/user1/go-app-counter-userspace:test
IMAGE_GT_US: ## Uprobe Userspace target. Example: make deploy-target IMAGE_GT_US=quay.io/user1/go-target-userspace:test
KIND_CLUSTER_NAME: ## Name of the deployed cluster to load example images to, defaults to `bpfman-deployment`
ignore-not-found: ## For any undeploy command, set to true to ignore resource not found errors during deletion. Example: make undeploy ignore-not-found=true

##@ Deployment
TAG_BC ?= latest
TAG_US ?= latest
USER_BC ?= bpfman-bytecode
USER_US ?= bpfman-userspace
IMAGE_TC_BC ?= quay.io/$(USER_BC)/go-tc-counter:$(TAG_BC)
IMAGE_TC_US ?= quay.io/$(USER_US)/go-tc-counter:$(TAG_US)
IMAGE_TCX_BC ?= quay.io/$(USER_BC)/go-tcx-counter:$(TAG_BC)
IMAGE_TCX_US ?= quay.io/$(USER_US)/go-tcx-counter:$(TAG_US)
IMAGE_TP_BC ?= quay.io/$(USER_BC)/go-tracepoint-counter:$(TAG_BC)
IMAGE_TP_US ?= quay.io/$(USER_US)/go-tracepoint-counter:$(TAG_US)
IMAGE_XDP_BC ?= quay.io/$(USER_BC)/go-xdp-counter:$(TAG_BC)
IMAGE_XDP_US ?= quay.io/$(USER_US)/go-xdp-counter:$(TAG_US)
IMAGE_KP_BC ?= quay.io/$(USER_BC)/go-kprobe-counter:$(TAG_BC)
IMAGE_KP_US ?= quay.io/$(USER_US)/go-kprobe-counter:$(TAG_US)
IMAGE_UP_BC ?= quay.io/$(USER_BC)/go-uprobe-counter:$(TAG_BC)
IMAGE_UP_US ?= quay.io/$(USER_US)/go-uprobe-counter:$(TAG_US)
IMAGE_URP_BC ?= quay.io/$(USER_BC)/go-uretprobe-counter:$(TAG_BC)
IMAGE_URP_US ?= quay.io/$(USER_US)/go-uretprobe-counter:$(TAG_US)
IMAGE_APP_BC ?= quay.io/$(USER_BC)/go-app-counter:$(TAG_BC)
IMAGE_APP_US ?= quay.io/$(USER_US)/go-app-counter:$(TAG_US)
IMAGE_GT_US ?= quay.io/$(USER_US)/go-target:$(TAG_US)
KIND_CLUSTER_NAME ?= bpfman-deployment


.PHONY: deploy-prog
deploy-prog: kustomize
ifndef TAG
	sed 's@URL_BC@$(IMAGE_BC)@' config/$(CONFIG_DIR)/patch.yaml.env > config/$(CONFIG_DIR)/patch.yaml
	cd config/$(CONFIG_DIR) && $(KUSTOMIZE) edit set image quay.io/bpfman-userspace/$(PROG_NAME)=${IMAGE_US}
	$(eval KUST_DIR=$(CONFIG_DIR))
else
	$(eval KUST_DIR=$(TAG)/$(PROG_NAME))
endif
	@if [ -f config/$(KUST_DIR)/kustomization.yaml ]; then \
		echo "Using KUST_DIR=$(KUST_DIR)" ; \
		$(KUSTOMIZE) build config/$(KUST_DIR) | kubectl apply -f - ; \
	else \
		echo "Manifests $(KUST_DIR) do not exist for program $(PROG_NAME)" ; \
		exit 1 ; \
	fi


.PHONY: undeploy-prog
undeploy-prog:
ifndef TAG
	sed 's@URL_BC@$(IMAGE_BC)@' config/$(CONFIG_DIR)/patch.yaml.env > config/$(CONFIG_DIR)/patch.yaml
	cd config/$(CONFIG_DIR) && $(KUSTOMIZE) edit set image quay.io/bpfman-userspace/$(PROG_NAME)=${IMAGE_US}
	$(eval KUST_DIR=$(CONFIG_DIR))
else
	$(eval KUST_DIR=$(TAG)/$(PROG_NAME))
endif
	@if [ -f config/$(KUST_DIR)/kustomization.yaml ]; then \
		echo "Using KUST_DIR=$(KUST_DIR)" ; \
		$(KUSTOMIZE) build config/$(KUST_DIR) | kubectl delete --ignore-not-found=$(ignore-not-found) -f -; \
	else \
		echo "Manifests $(KUST_DIR) does not exist for program $(PROG_NAME)" ; \
		exit 1 ; \
	fi

.PHONY: deploy-tc
deploy-tc: PROG_NAME=go-tc-counter
deploy-tc: CONFIG_DIR=default/$(PROG_NAME)
deploy-tc: IMAGE_BC=$(IMAGE_TC_BC)
deploy-tc: IMAGE_US=$(IMAGE_TC_US)
deploy-tc: deploy-prog ## Deploy go-tc-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tc
undeploy-tc: PROG_NAME=go-tc-counter
undeploy-tc: CONFIG_DIR=default/$(PROG_NAME)
undeploy-tc: IMAGE_BC=$(IMAGE_TC_BC)
undeploy-tc: IMAGE_US=$(IMAGE_TC_US)
undeploy-tc: undeploy-prog ## Undeploy go-tc-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-tcx
deploy-tcx: PROG_NAME=go-tcx-counter
deploy-tcx: CONFIG_DIR=default/$(PROG_NAME)
deploy-tcx: IMAGE_BC=$(IMAGE_TCX_BC)
deploy-tcx: IMAGE_US=$(IMAGE_TCX_US)
deploy-tcx: deploy-prog ## Deploy go-tcx-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tcx
undeploy-tcx: PROG_NAME=go-tcx-counter
undeploy-tcx: CONFIG_DIR=default/$(PROG_NAME)
undeploy-tcx: IMAGE_BC=$(IMAGE_TCX_BC)
undeploy-tcx: IMAGE_US=$(IMAGE_TCX_US)
undeploy-tcx: undeploy-prog ## Undeploy go-tcx-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-tracepoint
deploy-tracepoint: PROG_NAME=go-tracepoint-counter
deploy-tracepoint: CONFIG_DIR=default/$(PROG_NAME)
deploy-tracepoint: IMAGE_BC=$(IMAGE_TP_BC)
deploy-tracepoint: IMAGE_US=$(IMAGE_TP_US)
deploy-tracepoint: deploy-prog ## Deploy go-tracepoint-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tracepoint
undeploy-tracepoint: PROG_NAME=go-tracepoint-counter
undeploy-tracepoint: CONFIG_DIR=default/$(PROG_NAME)
undeploy-tracepoint: IMAGE_BC=$(IMAGE_TP_BC)
undeploy-tracepoint: IMAGE_US=$(IMAGE_TP_US)
undeploy-tracepoint: undeploy-prog ## Undeploy go-tracepoint-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-xdp
deploy-xdp: PROG_NAME=go-xdp-counter
deploy-xdp: CONFIG_DIR=default/$(PROG_NAME)
deploy-xdp: IMAGE_BC=$(IMAGE_XDP_BC)
deploy-xdp: IMAGE_US=$(IMAGE_XDP_US)
deploy-xdp: deploy-prog ## Deploy go-xdp-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-xdp
undeploy-xdp: PROG_NAME=go-xdp-counter
undeploy-xdp: CONFIG_DIR=default/$(PROG_NAME)
undeploy-xdp: IMAGE_BC=$(IMAGE_XDP_BC)
undeploy-xdp: IMAGE_US=$(IMAGE_XDP_US)
undeploy-xdp: undeploy-prog ## Undeploy go-xdp-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-xdp-ms
deploy-xdp-ms: PROG_NAME=go-xdp-counter
deploy-xdp-ms: CONFIG_DIR=default/go-xdp-counter-sharing-map
deploy-xdp-ms: IMAGE_BC=$(IMAGE_XDP_BC)
deploy-xdp-ms: IMAGE_US=$(IMAGE_XDP_US)
deploy-xdp-ms: deploy-prog ## Deploy go-xdp-counter-sharing-map (shares map with go-xdp-counter) to the cluster specified in ~/.kube/config.

.PHONY: undeploy-xdp-ms
undeploy-xdp-ms: PROG_NAME=go-xdp-counter
undeploy-xdp-ms: CONFIG_DIR=default/go-xdp-counter-sharing-map
undeploy-xdp-ms: IMAGE_BC=$(IMAGE_XDP_BC)
undeploy-xdp-ms: IMAGE_US=$(IMAGE_XDP_US)
undeploy-xdp-ms: undeploy-prog ## Undeploy go-xdp-counter-sharing-map from the cluster specified in ~/.kube/config.


.PHONY: deploy-kprobe
deploy-kprobe: PROG_NAME=go-kprobe-counter
deploy-kprobe: CONFIG_DIR=default/$(PROG_NAME)
deploy-kprobe: IMAGE_BC=$(IMAGE_KP_BC)
deploy-kprobe: IMAGE_US=$(IMAGE_KP_US)
deploy-kprobe: deploy-prog ## Deploy go-kprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-kprobe
undeploy-kprobe: PROG_NAME=go-kprobe-counter
undeploy-kprobe: CONFIG_DIR=default/$(PROG_NAME)
undeploy-kprobe: IMAGE_BC=$(IMAGE_KP_BC)
undeploy-kprobe: IMAGE_US=$(IMAGE_KP_US)
undeploy-kprobe: undeploy-prog ## Undeploy go-kprobe-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-uprobe
deploy-uprobe: PROG_NAME=go-uprobe-counter
deploy-uprobe: CONFIG_DIR=default/$(PROG_NAME)
deploy-uprobe: IMAGE_BC=$(IMAGE_UP_BC)
deploy-uprobe: IMAGE_US=$(IMAGE_UP_US)
deploy-uprobe: deploy-prog ## Deploy go-uprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-uprobe
undeploy-uprobe: PROG_NAME=go-uprobe-counter
undeploy-uprobe: CONFIG_DIR=default/$(PROG_NAME)
undeploy-uprobe: IMAGE_BC=$(IMAGE_UP_BC)
undeploy-uprobe: IMAGE_US=$(IMAGE_UP_US)
undeploy-uprobe: undeploy-prog ## Undeploy go-uprobe-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-uretprobe
deploy-uretprobe: PROG_NAME=go-uretprobe-counter
deploy-uretprobe: CONFIG_DIR=default/$(PROG_NAME)
deploy-uretprobe: IMAGE_BC=$(IMAGE_URP_BC)
deploy-uretprobe: IMAGE_US=$(IMAGE_URP_US)
deploy-uretprobe: deploy-prog ## Deploy go-uretprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-uretprobe
undeploy-uretprobe: PROG_NAME=go-uretprobe-counter
undeploy-uretprobe: CONFIG_DIR=default/$(PROG_NAME)
undeploy-uretprobe: IMAGE_BC=$(IMAGE_URP_BC)
undeploy-uretprobe: IMAGE_US=$(IMAGE_URP_US)
undeploy-uretprobe: undeploy-prog ## Undeploy go-uretprobe-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-app
deploy-app: PROG_NAME=go-app-counter
deploy-app: CONFIG_DIR=default/go-app-counter
deploy-app: IMAGE_BC=$(IMAGE_APP_BC)
deploy-app: IMAGE_US=$(IMAGE_APP_US)
deploy-app: deploy-prog ## Deploy go-app-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-app
undeploy-app: PROG_NAME=go-app-counter
undeploy-app: CONFIG_DIR=default/go-app-counter
undeploy-app: IMAGE_BC=$(IMAGE_APP_BC)
undeploy-app: IMAGE_US=$(IMAGE_APP_US)
undeploy-app: undeploy-prog ## Undeploy go-app-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-tc-selinux
deploy-tc-selinux: PROG_NAME=go-tc-counter
deploy-tc-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-tc-selinux: IMAGE_BC=$(IMAGE_TC_BC)
deploy-tc-selinux: IMAGE_US=$(IMAGE_TC_US)
deploy-tc-selinux: deploy-prog ## Deploy go-tc-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tc-selinux
undeploy-tc-selinux: PROG_NAME=go-tc-counter
undeploy-tc-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-tc-selinux: IMAGE_BC=$(IMAGE_TC_BC)
undeploy-tc-selinux: IMAGE_US=$(IMAGE_TC_US)
undeploy-tc-selinux: undeploy-prog ## Undeploy go-tc-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-tcx-selinux
deploy-tcx-selinux: PROG_NAME=go-tcx-counter
deploy-tcx-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-tcx-selinux: IMAGE_BC=$(IMAGE_TCX_BC)
deploy-tcx-selinux: IMAGE_US=$(IMAGE_TCX_US)
deploy-tcx-selinux: deploy-prog ## Deploy go-tcx-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tcx-selinux
undeploy-tcx-selinux: PROG_NAME=go-tcx-counter
undeploy-tcx-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-tcx-selinux: IMAGE_BC=$(IMAGE_TCX_BC)
undeploy-tcx-selinux: IMAGE_US=$(IMAGE_TCX_US)
undeploy-tcx-selinux: undeploy-prog ## Undeploy go-tcx-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-tracepoint-selinux
deploy-tracepoint-selinux: PROG_NAME=go-tracepoint-counter
deploy-tracepoint-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-tracepoint-selinux: IMAGE_BC=$(IMAGE_TP_BC)
deploy-tracepoint-selinux: IMAGE_US=$(IMAGE_TP_US)
deploy-tracepoint-selinux: deploy-prog ## Deploy go-tracepoint-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-tracepoint-selinux
undeploy-tracepoint-selinux: PROG_NAME=go-tracepoint-counter
undeploy-tracepoint-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-tracepoint-selinux: IMAGE_BC=$(IMAGE_TP_BC)
undeploy-tracepoint-selinux: IMAGE_US=$(IMAGE_TP_US)
undeploy-tracepoint-selinux: undeploy-prog ## Undeploy go-tracepoint-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-xdp-selinux
deploy-xdp-selinux: PROG_NAME=go-xdp-counter
deploy-xdp-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-xdp-selinux: IMAGE_BC=$(IMAGE_XDP_BC)
deploy-xdp-selinux: IMAGE_US=$(IMAGE_XDP_US)
deploy-xdp-selinux: deploy-prog ## Deploy go-xdp-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-xdp-selinux
undeploy-xdp-selinux: PROG_NAME=go-xdp-counter
undeploy-xdp-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-xdp-selinux: IMAGE_BC=$(IMAGE_XDP_BC)
undeploy-xdp-selinux: IMAGE_US=$(IMAGE_XDP_US)
undeploy-xdp-selinux: undeploy-prog ## Undeploy go-xdp-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-xdp-ms-selinux
deploy-xdp-ms-selinux: PROG_NAME=go-xdp-counter
deploy-xdp-ms-selinux: CONFIG_DIR=selinux/go-xdp-counter-sharing-map
deploy-xdp-ms-selinux: IMAGE_BC=$(IMAGE_XDP_BC)
deploy-xdp-ms-selinux: IMAGE_US=$(IMAGE_XDP_US)
deploy-xdp-ms-selinux: deploy-prog ## Deploy go-xdp-counter-sharing-map (shares map with go-xdp-counter) to the cluster specified in ~/.kube/config.

.PHONY: undeploy-xdp-ms-selinux
undeploy-xdp-ms-selinux: PROG_NAME=go-xdp-counter
undeploy-xdp-ms-selinux: CONFIG_DIR=selinux/go-xdp-counter-sharing-map
undeploy-xdp-ms-selinux: IMAGE_BC=$(IMAGE_XDP_BC)
undeploy-xdp-ms-selinux: IMAGE_US=$(IMAGE_XDP_US)
undeploy-xdp-ms-selinux: undeploy-prog ## Undeploy go-xdp-counter-sharing-map from the cluster specified in ~/.kube/config.


.PHONY: deploy-kprobe-selinux
deploy-kprobe-selinux: PROG_NAME=go-kprobe-counter
deploy-kprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-kprobe-selinux: IMAGE_BC=$(IMAGE_KP_BC)
deploy-kprobe-selinux: IMAGE_US=$(IMAGE_KP_US)
deploy-kprobe-selinux: deploy-prog ## Deploy go-kprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-kprobe-selinux
undeploy-kprobe-selinux: PROG_NAME=go-kprobe-counter
undeploy-kprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-kprobe-selinux: IMAGE_BC=$(IMAGE_KP_BC)
undeploy-kprobe-selinux: IMAGE_US=$(IMAGE_KP_US)
undeploy-kprobe-selinux: undeploy-prog ## Undeploy go-kprobe-counter from the cluster specified in ~/.kube/config.


.PHONY: deploy-uprobe-selinux
deploy-uprobe-selinux: PROG_NAME=go-uprobe-counter
deploy-uprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-uprobe-selinux: IMAGE_BC=$(IMAGE_UP_BC)
deploy-uprobe-selinux: IMAGE_US=$(IMAGE_UP_US)
deploy-uprobe-selinux: deploy-prog ## Deploy go-uprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-uprobe-selinux
undeploy-uprobe-selinux: PROG_NAME=go-uprobe-counter
undeploy-uprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-uprobe-selinux: IMAGE_BC=$(IMAGE_UP_BC)
undeploy-uprobe-selinux: IMAGE_US=$(IMAGE_UP_US)
undeploy-uprobe-selinux: undeploy-prog ## Undeploy go-uprobe-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-uretprobe-selinux
deploy-uretprobe-selinux: PROG_NAME=go-uretprobe-counter
deploy-uretprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
deploy-uretprobe-selinux: IMAGE_BC=$(IMAGE_URP_BC)
deploy-uretprobe-selinux: IMAGE_US=$(IMAGE_URP_US)
deploy-uretprobe-selinux: deploy-prog ## Deploy go-uretprobe-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-uretprobe-selinux
undeploy-uretprobe-selinux: PROG_NAME=go-uretprobe-counter
undeploy-uretprobe-selinux: CONFIG_DIR=selinux/$(PROG_NAME)
undeploy-uretprobe-selinux: IMAGE_BC=$(IMAGE_URP_BC)
undeploy-uretprobe-selinux: IMAGE_US=$(IMAGE_URP_US)
undeploy-uretprobe-selinux: undeploy-prog ## Undeploy go-uretprobe-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-app-selinux
deploy-app-selinux: PROG_NAME=go-app-counter
deploy-app-selinux: CONFIG_DIR=selinux/go-app-counter
deploy-app-selinux: IMAGE_BC=$(IMAGE_APP_BC)
deploy-app-selinux: IMAGE_US=$(IMAGE_APP_US)
deploy-app-selinux: deploy-prog ## Deploy go-app-counter to the cluster specified in ~/.kube/config.

.PHONY: undeploy-app-selinux
undeploy-app-selinux: PROG_NAME=go-app-counter
undeploy-app-selinux: CONFIG_DIR=selinux/go-app-counter
undeploy-app-selinux: IMAGE_BC=$(IMAGE_APP_BC)
undeploy-app-selinux: IMAGE_US=$(IMAGE_APP_US)
undeploy-app-selinux: undeploy-prog ## Undeploy go-app-counter from the cluster specified in ~/.kube/config.

.PHONY: deploy-target
deploy-target: ## Deploy go-target to the cluster specified in ~/.kube/config.
	kubectl apply -f config/base/go-target/deployment.yaml

.PHONY: undeploy-target
undeploy-target: ## Undeploy go-target from the cluster specified in ~/.kube/config.
	kubectl delete -f config/base/go-target/deployment.yaml

DEPLOY_TARGETS = deploy-tc deploy-tcx deploy-tracepoint deploy-xdp deploy-xdp-ms deploy-kprobe deploy-target deploy-uprobe deploy-uretprobe deploy-app

.PHONY: deploy
deploy: ## Deploy all examples to the cluster specified in ~/.kube/config.
ifdef TAG
	$(eval TAG_COMMAND="TAG=$(TAG)")
endif
	for target in $(DEPLOY_TARGETS) ; do \
		$(MAKE) $$target $(TAG_COMMAND) || true; \
	done

UNDEPLOY_TARGETS = undeploy-tc undeploy-tcx undeploy-tracepoint undeploy-xdp-ms undeploy-xdp undeploy-kprobe undeploy-uprobe undeploy-uretprobe undeploy-target undeploy-app

.PHONY: undeploy
undeploy: ## Undeploy all examples to the cluster specified in ~/.kube/config.
ifdef TAG
	$(eval TAG_COMMAND="TAG=$(TAG)")
endif
	for target in $(UNDEPLOY_TARGETS) ; do \
		$(MAKE) $$target $(TAG_COMMAND) || true; \
	done
