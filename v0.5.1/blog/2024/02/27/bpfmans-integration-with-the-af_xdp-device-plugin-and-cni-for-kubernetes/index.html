
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../26/technical-challenges-for-attaching-ebpf-programs-in-containers/">
      
      
      
      <link rel="icon" href="../../../../../img/favicon.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.11">
    
    
      
        <title>bpfman's Integration with the AF_XDP Device Plugin and CNI for Kubernetes - bpfman</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bpfmans-integration-with-the-af_xdp-device-plugin-and-cni-for-kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="bpfman" class="md-header__button md-logo" aria-label="bpfman" data-md-component="logo">
      
  <img src="../../../../../img/favicon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            bpfman
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              bpfman's Integration with the AF_XDP Device Plugin and CNI for Kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bpfman/bpfman" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../quick-start/" class="md-tabs__link">
        
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../getting-started/overview/" class="md-tabs__link">
          
  
    
  
  Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../governance/CONTRIBUTING/" class="md-tabs__link">
          
  
    
  
  Developer Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../design/daemonless/" class="md-tabs__link">
          
  
    
  
  Design

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../governance/MEETINGS/" class="md-tabs__link">
          
  
    
  
  Community

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="bpfman" class="md-nav__button md-logo" aria-label="bpfman" data-md-component="logo">
      
  <img src="../../../../../img/favicon.svg" alt="logo">

    </a>
    bpfman
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bpfman/bpfman" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpfman Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/launching-bpfman/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Launching bpfman
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/example-bpf-local/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying Example eBPF Programs On Local Host
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/example-bpf-k8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying Example eBPF Programs On Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/building-bpfman/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup and Building
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/running-release/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run bpfman From Release Image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/running-rpm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run bpfman From RPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/cli-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/example-bpf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example eBPF Programs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/REVIEWING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reviewing Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/operator-quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying the bpfman-operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/develop-operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developing the bpfman-operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/api-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes CRD API-Reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/shipping-bytecode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Bytecode Image Specifications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/image-build/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpfman Container Images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/linux-capabilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Capabilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/debugging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/release/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Releasing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/xdp-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    XDP Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../developer-guide/k8s-selinux-distros/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running the Examples as Non-Root on SELinux Distributions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Design
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../design/daemonless/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Daemonless
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/community-meeting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Community Meeting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Community
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/MEETINGS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meetings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/GOVERNANCE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Governance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/CODE_OF_CONDUCT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code of Conduct
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/MAINTAINERS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maintainers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../governance/SECURITY/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-does-the-af_xdp-device-plugin-and-cni-do" class="md-nav__link">
    <span class="md-ellipsis">
      What does the AF_XDP Device Plugin and CNI do?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What does the AF_XDP Device Plugin and CNI do?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bpfman-integration" class="md-nav__link">
    <span class="md-ellipsis">
      bpfman Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="bpfman Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integration-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Integration benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#af_xdp-device-plugin-ebpf-programmap-management" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP Device Plugin eBPF program/map management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#af_xdp-cni-ebpf-programmap-management" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP CNI eBPF program/map management
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#is-there-a-working-example" class="md-nav__link">
    <span class="md-ellipsis">
      Is there a working example?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#af_xdp-dp-and-cnis-integration-with-bpfman-in-images" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP DP and CNI's integration with bpfman in images
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AF_XDP DP and CNI's integration with bpfman in images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#af_xdp-dp-and-cni-managing-ebpf-programs-independently" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP DP and CNI managing eBPF programs independently
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#af_xdp-dp-and-cni-integrated-with-bpfman-no-csi" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP DP and CNI integrated with bpfman (no csi)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#af_xdp-dp-and-cni-integrated-with-bpfman-with-csi" class="md-nav__link">
    <span class="md-ellipsis">
      AF_XDP DP and CNI integrated with bpfman (with csi)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://github.com/maryamtahhan.png" alt="Maryam Tahhan">
                    </span>
                    <span class="md-profile__description">
                      <strong>Maryam Tahhan</strong><br>
                      Principal Engineer at Red Hat. Working on AF_XDP and integration into Kubernetes.
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                        <time datetime="2024-02-27 00:00:00" class="md-ellipsis">February 27, 2024</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                          <span class="md-ellipsis">
                            
                              8 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        

  
  


<h1 id="bpfmans-integration-with-the-af_xdp-device-plugin-and-cni-for-kubernetes">bpfman's Integration with the AF_XDP Device Plugin and CNI for Kubernetes</h1>
<p><a href="https://www.kernel.org/doc/html/next/networking/af_xdp.html">AF_XDP</a> is an address/socket family that is optimized for high performance packet processing.
It takes advantage of <a href="https://docs.cilium.io/en/latest/bpf/progtypes/#xdp">XDP</a> (an in Kernel fastpath), which essentially runs an eBPF
program as early as possible on a network driver's receive path, and redirects the
packet to an AF_XDP socket.</p>
<p><img alt="AF_XDP" src="../../../../img/2024-02-27/AF_XDP-overview.png" /></p>
<p>AF_XDP sockets (XSKs) are created in Userspace and have a 1:1 mapping with netdev queues.
An XSKMAP is an eBPF map of AF_XDP sockets for a particular netdev. It's a simple key:value
map where the key is the netdev's queue-id and the value is the AF_XDP socket that's attached
to that queue. The eBPF program (at the XDP hook) will leverage the XSKMAP and the XDP_REDIRECT
action to redirect packets to an AF_XDP socket. In the image below the XDP program is redirecting
an incoming packet to the XSK attached to Queue 2.</p>
<blockquote>
<p><strong>NOTE</strong>: If no XSK is attached to a queue, the XDP program will simply pass the packet to the
Kernel Network Stack.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>+---------------------------------------------------+
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">|</span><span class="w">     </span>XSK<span class="w"> </span>A<span class="w">      </span><span class="p">|</span><span class="w">     </span>XSK<span class="w"> </span>B<span class="w">       </span><span class="p">|</span><span class="w">      </span>XSK<span class="w"> </span>C<span class="w">     </span><span class="p">|</span>&lt;---+<span class="w">  </span><span class="nv">Userspace</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="o">=========================================================</span><span class="p">|</span><span class="o">==========</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">|</span><span class="w">    </span>Queue<span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w">     </span>Queue<span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w">     </span>Queue<span class="w"> </span><span class="m">2</span><span class="w">    </span><span class="p">|</span><span class="w">    </span><span class="p">|</span><span class="w">  </span>Kernel<span class="w"> </span>space
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>+---------------------------------------------------+<span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">|</span><span class="w">                  </span>Netdev<span class="w"> </span>eth0<span class="w">                      </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>+---------------------------------------------------+<span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">|</span><span class="w">                            </span>+<span class="o">=============</span>+<span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">|</span><span class="w">                            </span><span class="p">|</span><span class="w"> </span>key<span class="w"> </span><span class="p">|</span><span class="w">  </span>xsk<span class="w">  </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">|</span><span class="w">  </span>+---------+<span class="w">               </span>+<span class="o">=============</span>+<span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">               </span><span class="p">|</span><span class="w">  </span><span class="m">0</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>xsk<span class="w"> </span>A<span class="w"> </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">               </span>+-------------+<span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">               </span><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>xsk<span class="w"> </span>B<span class="w"> </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>BPF<span class="w">     </span><span class="p">|</span><span class="w">               </span>+-------------+<span class="w">        </span><span class="p">|</span><span class="w">    </span><span class="p">|</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>prog<span class="w">    </span><span class="p">|</span>--<span class="w"> </span>redirect<span class="w"> </span>--&gt;<span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>xsk<span class="w"> </span>C<span class="w"> </span><span class="p">|</span>-------------+
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="o">(</span>XDP<span class="w">    </span><span class="p">|</span><span class="w">               </span>+-------------+<span class="w">        </span><span class="p">|</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span>HOOK<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w">                   </span>xskmap<span class="w">             </span><span class="p">|</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">                                      </span><span class="p">|</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="p">|</span><span class="w">  </span>+---------+<span class="w">                                      </span><span class="p">|</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="p">|</span><span class="w">                                                   </span><span class="p">|</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>+---------------------------------------------------+
</code></pre></div>
<p>The <a href="https://github.com/intel/afxdp-plugins-for-kubernetes">AF_XDP Device Plugin and CNI</a> project provides the Kubernetes components to
provision, advertise and manage AF_XDP networking devices for Kubernetes pods. These
networking devices are typically used as a Secondary networking interface for a pod.
A key goal of this project is to enable pods to run without any special privileges,
without it pods that wish to use AF_XDP will need to run with elevated privileges
in order to manage the eBPF program on the interface. The infrastructure
will have little to no control over what these pods can load. Therefore it's ideal
to leverage a central/infrastructure centric eBPF program management approach.  This blog
will discuss the eBPF program management journey for the AF_XDP Device Plugin and CNI.</p>
<!-- more -->

<h2 id="what-does-the-af_xdp-device-plugin-and-cni-do">What does the AF_XDP Device Plugin and CNI do?</h2>
<p>For pods to create and use AF_XDP sockets on their interfaces, they can either:</p>
<ol>
<li>Create the AF_XDP socket on an interface already plumbed to the Pod (via SR-IOV
   Device Plugin and the Host CNI) --&gt; But this requires CAP_BPF or CAP_SYS_ADMIN
   privileges in order to load the BPF program on the netdev.</li>
</ol>
<p>OR</p>
<ol>
<li>
<p>Use the AF_XDP Device Plugin (DP) and CNI in order to support a Pod without the
   aforementioned root like privileges.</p>
<blockquote>
<p><strong>NOTE</strong>: Prior to kernel 5.19, all BPF sys calls required CAP_BPF, which are
used to access maps shared between the BPF program and the userspace program.
In kernel 5.19, a change went in that only requires CAP_BPF for map creation
(BPF_MAP_CREATE) and loading programs (BPF_PROG_LOAD).</p>
</blockquote>
<p>In this scenario, the <code>AF_XDP DP</code>, will advertise resource pools (of netdevs) to
<code>Kubelet</code>. When a Pod requests a resource from these pools, <code>Kubelet</code> will
<code>Allocate()</code> one of these devices through the <code>AF_XDP DP</code>. The <code>AF_XDP DP</code> will load the eBPF
program (to redirect packets to an AF_XDP socket) on the allocated device.</p>
<p>The default behaviour of the <code>AF_XDP DP</code> (unless otherwise configured) is to take note of the
XSKMAP File Descriptor (FD) for that netdev. It will also mount a Unix Domain Socket
(UDS), as a hostpath mount, in the Pod. This UDS will be used by the AF_XDP application
to perform a handshake with the <code>AF_XDP DP</code> to retrieve the XSKMAP FD. The application needs
the XSKMAP FD to "attach" AF_XDP sockets it creates to the netdev queues.</p>
<blockquote>
<p><strong>NOTE</strong>: Newer versions of the <code>AF_XDP DP</code> support eBPF map pinning which eliminate the
need to perform this (non trivial) handshake with AF_XDP pods. It now mounts the
pinned XSKMAP into the Pod using a hostpath mount. The downside of this approach is that
the <code>AF_XDP DP</code> now needs to manage several eBPF File Systems (BPFFS), one per pod.</p>
</blockquote>
<p>The <code>AF_XDP CNI</code> (like any CNI) has the task of moving the netdev (with the loaded eBPF
program) into the Pod namespace. It also does a few other important things:</p>
<ul>
<li>It does not rename the netdev (to allow the DP to avoid IF_INDEX clashes as it manages
     the AF_XDP resource pools).</li>
<li>The CNI is also capable of configuring hardware filters on the NIC.</li>
<li>Finally, the CNI also unloads the eBPF program from the netdev and clear any hardware
    filters when the Pod is terminated.</li>
</ul>
<blockquote>
<p><strong>NOTE 1</strong>: The <code>AF_XDP CNI</code> manages the unloading of the eBPF program due to the <code>AF_XDP DP</code>
not being aware of when a pod terminates (it's only invoked by <code>Kubelet</code> during pod creation).</p>
<p><strong>NOTE 2</strong>: Prior to bpfman integration, the CNI was extended to signal the AF_XDP DP on pod
termination (via gRPC) in an effort to support eBPF map pinning directly in the AF_XDP DP. The
AF_XDP DP was managing BPFFS(es) for map pinning and needed to be signalled to clean them up.</p>
</blockquote>
</li>
</ol>
<h3 id="bpfman-integration">bpfman Integration</h3>
<p>Prior to bpfman integration the AF_XDP Device Plugin and CNI managed the eBPF program
for redirecting incoming packets to AF_XDP sockets, its associated map (XSKMAP), and/or several BPFFS.</p>
<h4 id="integration-benefits">Integration benefits</h4>
<p>So what are the benefits of bpfman integration for the AF_XDP DP and CNI?</p>
<ul>
<li>
<p>Removes code for loading and managing eBPF from the AF_XDP DP and CNI codebase.</p>
</li>
<li>
<p>This presented a difficulty particularly when trying to find/update appropriate
    base container images to use for the AF_XDP device plugin. Different images
    supported different versions of eBPF management libraries (i.e libbpf or libxdp) which
    forced multiple changes around the loading and attaching of the base eBPF program.</p>
</li>
<li>
<p>Additionally the CNI runs as a binary on the Kubernetes node so we would need to
    statically compile libbpf/libxdp as part of the CNI.</p>
</li>
<li>
<p>More diverse XDP program support through bpfman's eBPF Bytecode Image Specification. Not
  only do the AF_XDP eBPF programs no longer need to be stored in the Device Plugin
  itself, but it's now configurable on a per pool basis.</p>
</li>
<li>
<p>No longer required to leverage Hostpath volume mounts to mount the AF_XDP maps inside
  a Pod. But rather take advantage of the bpfman CSI support to ensure that maps are
  pinned in the context of the Pod itself and not in a BPFFS on the host (then shared
  to the Pod).</p>
</li>
</ul>
<h4 id="af_xdp-device-plugin-ebpf-programmap-management">AF_XDP Device Plugin eBPF program/map management</h4>
<p>The role of the <code>AF_XDP DP</code> in eBPF program/map management <strong>prior to bpfman integration</strong>:</p>
<ul>
<li>
<p>Loads the default AF_XDP BPF prog onto the netdev at Pod creation and manages info
regarding the XSKMAP for that netdev.</p>
</li>
<li>
<p>Mounts a UDS as a hostpath volume in the Pod OR creates a BPFFS per netdev and pins the
  XSKMAP to it, then mounts this BPFFS as a hostpath volume in the Pod.</p>
</li>
<li>
<p>Shares the XSKMAP file descriptor via UDS (involves a handshake with the Pod).</p>
</li>
</ul>
<p>The role of the <code>AF_XDP DP</code> in eBPF program/map management <strong>after bpfman integration</strong>:</p>
<ul>
<li>
<p>Uses bpfman's client APIs to load the BPF prog.</p>
</li>
<li>
<p>Shares the XSKMAP (that bpfman pinned ) with the Pod as a hostpath volume.</p>
</li>
</ul>
<h4 id="af_xdp-cni-ebpf-programmap-management">AF_XDP CNI eBPF program/map management</h4>
<p>The role of the <code>AF_XDP CNI</code> in eBPF program/map management <strong>prior to bpfman integration</strong>:</p>
<ul>
<li>Unloads the eBPF program when a device is returned to the Host network namespace.</li>
</ul>
<p>The role of the <code>AF_XDP CNI</code> in eBPF program/map management <strong>after bpfman integration</strong>:</p>
<ul>
<li>Uses gRPC to signal to the Device Plugin to request bpfman to unload the eBPF program
  using the client APIs.</li>
</ul>
<h2 id="is-there-a-working-example">Is there a working example?</h2>
<p>The bpfman integration with the AF_XDP Device Plugin and CNI was demo'ed as part
of a series of demos that show the migration of a DPDK application to AF_XDP (without)
any application modification. The demo can be watched below:</p>
<p><a href="https://www.youtube.com/embed/wcmSO5HwNJQ"><img src="https://img.youtube.com/vi/wcmSO5HwNJQ/hqdefault.jpg" width="600" height="300"
/></a></p>
<h2 id="af_xdp-dp-and-cnis-integration-with-bpfman-in-images">AF_XDP DP and CNI's integration with bpfman in images</h2>
<p>The following sections will present the evolution of the AF_XDP DP and CNI
from independent eBPF program management to leveraging bpfman to manage eBPF programs on
their behalf.</p>
<h3 id="af_xdp-dp-and-cni-managing-ebpf-programs-independently">AF_XDP DP and CNI managing eBPF programs independently</h3>
<p>The following diagram details how the AF_XDP DP and CNI worked prior to bpfman integration.</p>
<p><img alt="AF_XDP DP and CNI managing eBPF programs independently" src="../../../../img/2024-02-27/af_xdp.png" /></p>
<ol>
<li>
<p>Setup Subfunctions on the network devices (if the are supported/being used).</p>
</li>
<li>
<p>Create an AF_XDP DP and CNI configuration file to setup the device resource pools and
   deploy the DP and CNI.</p>
</li>
<li>
<p>When the AF_XDP DP runs it will discover the netdevs on the host and create the resource pools.</p>
</li>
<li>
<p>The AF_XDP DP registers the resource pools with Kubelet.</p>
</li>
<li>
<p>When a pod (that requests an AF_XDP resource) is started, Kubelet will send an <code>Allocate()</code>
   request to the AF_XDP DP. The AF_XDP DP loads the eBPF program on the interface and mounts the
   UDS in the pod and sets some environment variables in the pod using the Downward API.</p>
</li>
</ol>
<blockquote>
<p><strong>NOTE</strong>: In the case where eBPF map pinning is used rather than the UDS, the AF_XDP
   DP will create a BPFFS where it pins the XSKMAP and mounts the BPFFS as a hostpath volume
   in the pod.</p>
</blockquote>
<ol>
<li>
<p>The AF_XDP DP signals success to the Kubelet so that the device is added to the pod.</p>
</li>
<li>
<p>Kubelet triggers multus, which in turn triggers the AF_XDP CNI. The CNI does the relevant network
   configuration and moves the netdev into the pod network namespace.</p>
</li>
<li>
<p>The application in the pod start and initiates a handshake with the AF_XDP DP over the mounted UDS
   to retrieve the XSKMAP FD.</p>
</li>
</ol>
<h3 id="af_xdp-dp-and-cni-integrated-with-bpfman-no-csi">AF_XDP DP and CNI integrated with bpfman (no csi)</h3>
<p>The following diagram details how the AF_XDP DP and CNI worked after bpfman integration.</p>
<p><img alt="AF_XDP DP and CNI integrated with bpfman (no csi)" src="../../../../img/2024-02-27/af_xdp-bpfman-no-csi.png" /></p>
<p>The main difference here is that when the <code>Allocate()</code> request comes in from Kubelet, the AF_XDP
DP uses the bpfman client API to load the eBPF program on the relevant netdev. It takes note of
where bpfman pins the XSKMAP and mounts this directory as a hostpath volume in the pod.</p>
<h3 id="af_xdp-dp-and-cni-integrated-with-bpfman-with-csi">AF_XDP DP and CNI integrated with bpfman (with csi)</h3>
<p>The following diagram details how the AF_XDP DP and CNI will work with bpfman leveraging
the new CSI implementation.</p>
<p><img alt="AF_XDP DP and CNI integrated with bpfman (with csi)" src="../../../../img/2024-02-27/af_xdp-bpfman-csi.png" /></p>
<p>The pod will include a volume definition as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w">   </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bpf-maps</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">     </span><span class="nt">csi</span><span class="p">:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">       </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">csi.bpfman.dev</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">       </span><span class="nt">volumeAttributes</span><span class="p">:</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">         </span><span class="nt">csi.bpfman.dev/thru-annotations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p>The idea here is when the <code>Allocate()</code> request comes in from Kubelet, the AF_XDP
DP uses the bpfman client API to load the eBPF program on the relevant netdev. The
AF_XDP DP will annotate the pod with the XdpProgram name, map and mountpath. When the
bpfman CSI plugin is triggered by Kubelet, it will retrieve the information it needs
from the pod annotations in order to pin the map inside the Pod.</p>



  



      
    </article>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information -->
<div class="md-copyright">
    
      <div class="md-copyright__highlight">
        Copyright &copy; 2021-2024 The bpfman contributors.<br>The Linux Foundation (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a>.
      </div>
    
    
      Made with
      <a
        href="https://squidfunk.github.io/mkdocs-material/"
        target="_blank" rel="noopener"
      >
        Material for MkDocs
      </a>
    
  </div>
  <div class="md-copyright__netlify">
    <a href="https://www.netlify.com"> <img src="https://www.netlify.com/v3/img/components/netlify-color-accent.svg" alt="Deploys by Netlify" /> </a>
  </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.6c14ae12.min.js"></script>
      
    
  </body>
</html>